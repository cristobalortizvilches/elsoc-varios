---
title: "Cohesión barrial en perspectiva longitudinal y territorial"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: flatly
---

```{r setup}
knitr::opts_chunk$set(echo = FALSE, warnings = FALSE, message = FALSE)

library(elsoc)
library(survey)
library(tidyverse)
library(ggalluvial)
library(scales)
library(sjlabelled)
library(sjmisc)
library(ggrepel)
library(chilemapas)
library(ggthemes) 
```

```{r cargar-bases}
remove(list = ls())

# Cargar bases desde Dataverse
load(url("https://dataverse.harvard.edu/api/access/datafile/10797987")) # long 2016-2023
load(url("https://dataverse.harvard.edu/api/access/datafile/10797986")) # wide 2016-2023

load("../1_input/original-data/elsoc_chile.RData")

neig_cities <- read.csv("../1_input/original-data/nse_barrio_muestra_nacional.csv") |> 
  dplyr::select(idencuesta, nse_barrio_norm)
```

```{r recodificar-vars}
elsoc_long_2016_2023[elsoc_long_2016_2023 == -888 | elsoc_long_2016_2023 == -999 | elsoc_long_2016_2023 == 994 | elsoc_long_2016_2023 == 995 | elsoc_long_2016_2023 == 996 | elsoc_long_2016_2023 == -666 | elsoc_long_2016_2023 == -777] <- NA # varias categorías a NA

elsoc_base <- elsoc_long_2016_2023 %>%
  filter(tipo_atricion == 1, muestra %in% 1:2) %>%
  mutate(
    # t02_ ProMedium sentido de Belonging
    spbi = rowMeans(dplyr::select(., t02_01, t02_02, t02_03, t02_04), na.rm = TRUE),
    # t03_ ProMedium Sociability  vecinal
    soci = rowMeans(dplyr::select(., t03_01, t03_02, t03_03, t03_04), na.rm = TRUE),
    repu = t08,
    segu = t10) %>% 
  mutate(
    # t02_ ProMedium sentido de Belonging recodificado
    spbi_reco = factor(cut(spbi, breaks = c(0,2.5,3.5,5), labels = c(1,2,3)), labels = c("Low", "Medium", "High")),
    # t05 Rootedness físico
    arra_fisi = factor(car::recode(t05, "c(1,2,4)=1; c(3)=2"), labels = c("Low", "High")),
    # t03_ ProMedium Sociability  vecinal recodificado
    soci_reco = factor(cut(soci, breaks = c(0,2.5,3.5,5), labels = c(1,2,3)), labels = c("Low", "Medium", "High")),
    # t01	Cuanto confía usted en sus vecinos (4 y 5 = Bastante o Mucho)
    conf_veci = factor(car::recode(t01, "1:2 = 1;  3 = 2;  4:5 = 3"), labels = c("Low", "Medium", "High")),
    # c07_01 Visito la casa de vecino  (2 y 3 = lo hizo una o más veces)
    apoy_veci = factor(car::recode(c07_01, "c(1,2)=1; c(3)=2"), labels = c("Low", "High")),
    # c12_01 Participation en juntas de vecinos
    part_jjvv = factor(car::recode(c12_01, "c(1,2)=1; c(3)=2"), labels = c("Low", "High")), 
    # t08 Reputación territorial
    repu_terr = factor(car::recode(t08, "c(1,2)=1; c(3)=2; c(4,5)=3"), labels = c("Negativa", "Neutra", "Positiva")),
    # t10 Seguridad barrial
    segu_terr = factor(car::recode(t10, "c(1,2)=1; c(3)=2; c(4,5)=3"), labels = c("Low", "Medium", "High")),
    # controles
    sexo = as_label(m0_sexo), 
    edad = factor(car::recode(m0_edad, "18:29=1; 30:49=2; 50:64=3; 65:150=4"),
                  labels = c('18-29', '30-49', '50-64', '65 o más'), levels = 1:4),
    educ = factor(car::recode(m01,"1:3=1; 4:5=2; 6:7=3; 8:10=4"),
                  labels = c("Primary", "Secondary", "Technical", "Universitary"), levels = 1:4),
  ) %>%
  as_label(ola) %>% 
  dplyr::select(idencuesta, segmento_disenno, estrato_disenno, ponderador02, ola, 
                spbi, soci, repu, segu,
                spbi_reco, arra_fisi, soci_reco, conf_veci, apoy_veci, part_jjvv, repu_terr, segu_terr, sexo, edad, educ) %>% 
  left_join(neig_cities, by = "idencuesta") %>% 
  mutate(nse_barrio = fct_rev(factor(ntile(nse_barrio_norm, 3), labels = c("Low", "Medium", "High"))),
         perfil_terr = case_when(
           # Regla 1: Perfil Óptimo (ambas Highs): repu y segu sean 4 o 5.
           repu >= 4 & segu >= 4   ~ "High — High",
           # Regla 2: Perfil Crítico (ambas Lows): repu y segu sean 1 o 2.
           repu <= 2 & segu <= 2   ~ "Low — Low",
           # Regla 3: Fortaleza en Reputación (reputación High, seguridad no). Se evalúa DESPUÉS de la regla 1, solo captura los casos donde t08 es High pero t10 no lo es.
           repu >= 4 ~ "High — Medium/Low",
           # Regla 4: Fortaleza en Seguridad (seguridad High, reputación no). Se evalúa DESPUÉS de las reglas 1 y 3.
           segu >= 4 ~ "Medium/Low — High",
           # Regla 5: Perfil InterMedium (todos los demás casos) 'TRUE ~' actúa como un "ELSE" que captura todo lo que no cumplió las condiciones anteriores.
           TRUE  ~ "Medium — Medium")) %>% 
  mutate(perfil_terr = factor(perfil_terr,
                              levels = c("Low — Low",
                                         "Medium — Medium",
                                         "Medium/Low — High",
                                         "High — Medium/Low",
                                         "High — High")))

N_muestra <- elsoc_base %>%
  summarise(N = trunc(n() / n_distinct(ola))) %>%
  pull(N)  
```

```{r cob-longitudinal}
library(dplyr)
library(tidyr)
library(forcats)
library(ggplot2)
library(scales)

# =========================
# 1) Preparar datos base
# =========================
cob_inter <- elsoc_base %>% 
  pivot_longer(cols = c(spbi_reco, arra_fisi, soci_reco, conf_veci, apoy_veci, part_jjvv)) %>% 
  prop(value == "High", by = c(ola, name), na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('spbi_reco', 'arra_fisi', 'soci_reco', 'conf_veci', 'apoy_veci', 'part_jjvv'),
                       labels = c('Belonging', 'Rootedness',
                                  'Sociability', 'Trust',
                                  'Visits', 'Participation')))

# =========================
# 2) Orden por promedio
# =========================
cob_inter_prom <- cob_inter %>%
  group_by(name) %>%
  summarise(Medium_prop = mean(prop, na.rm = TRUE), .groups = "drop") %>%
  arrange(desc(Medium_prop))

orden_leyenda <- cob_inter_prom %>% pull(name) %>% as.character()

pct1 <- percent_format(accuracy = 0.1)
cob_inter <- cob_inter %>%
  left_join(cob_inter_prom, by = "name") %>%
  mutate(name_label = paste0(name, " (", pct1(Medium_prop), ")"))

orden_leyenda_labels <- paste0(orden_leyenda, " (", pct1(cob_inter_prom$Medium_prop), ")")

cob_inter <- cob_inter %>%
  mutate(name_label = fct_relevel(name_label, orden_leyenda_labels))

# =========================
# 3) Paleta institucional (6 tonos)
# =========================
pal6 <- c(
  "#233640", "#476473",  # azul petróleo
  "#C75827", "#F08B57",  # naranjo
  "#879F8D", "#B7C8BE"   # verde suave
)

pal_named <- setNames(pal6, orden_leyenda_labels)

# =========================
# 4) Gráfico
# =========================
cob_inter_plot <- cob_inter %>% 
  ggplot(aes(y = prop, x = ola, fill = name_label, group = name_label,
             label = percent(prop, accuracy = .1))) +
  geom_line(aes(color = name_label), size = 1) +
  geom_point(aes(color = name_label), size = 2.5) +   # Puntos SIN contorno
  scale_fill_manual(values = pal_named, drop = FALSE) +
  scale_color_manual(values = pal_named, drop = FALSE) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.2),
                     labels = percent, limits = c(0, 1)) +
  labs(
    title = "Neighborhood-level social cohesion indicators over time",
    subtitle = "Percentage of respondents scoring high on each indicator",
    caption = "Source: Own elaboration based on ELSOC 2016–2023. Weighted sample without attrition across waves (N = 1648).",
    y = NULL, x = NULL, 
    color = expression("Neighborhood cohesion (" * bar(x) * ")"),
    fill  = expression("Neighborhood cohesion (" * bar(x) * ")")
  ) +
  theme_hc() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = 11, vjust = 1, hjust = 0.20, face = "bold"),
    plot.subtitle = element_text(size = 10, vjust = 1, hjust = 0.2),
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10),
    axis.text = element_text(size = 9),
    axis.text.x = element_text(angle = 65, vjust = 1, hjust = 1),  # etiquetas verticales
    strip.text = element_text(size = 10),
    plot.caption = element_text(size = 9, vjust = -1,  hjust = 0.2
  ))

# =========================
# 5) Guardar y mostrar
# =========================
ggsave(filename = "../3_output/cohesion_barrial/cob_inter_plot.svg",
       plot = cob_inter_plot, width = 8, height = 6, units = "in", dpi = 2400)

cob_inter_plot
```

```{r cob-longitudinal-segu}
numic_palette <- c(
  "High"     = "#2E4553",  # azul petróleo
  "Medium" = "#E56A2F",  # naranjo
  "Low"      = "#9DB5A2"   # verde suave
)
# 1. Preparar datos con nombres y orden correctos
cob_inter_segu <- elsoc_base %>% 
  pivot_longer(cols = c(spbi_reco, arra_fisi, soci_reco, 
                        conf_veci, apoy_veci, part_jjvv)) %>% 
  prop(value == "High", by = c(ola, name, segu_terr), na.rm = TRUE) %>%
  mutate(name = recode(name,
                       'spbi_reco'  = 'Belonging',
                       'soci_reco'  = 'Sociability',
                       'apoy_veci'  = 'Visits',
                       'arra_fisi'  = 'Rootedness',
                       'conf_veci'  = 'Trust',
                       'part_jjvv'  = 'Participation'),
         name = factor(name, levels = c("Belonging", "Sociability", "Visits",
                                        "Rootedness", "Trust", "Participation"))) %>% 
  drop_na() %>% 
  ggplot(aes(x = ola, y = prop, group = fct_rev(segu_terr), fill = fct_rev(segu_terr))) +
  geom_line(aes(color = fct_rev(segu_terr)), size = 0.5) +
  geom_point(aes(color = fct_rev(segu_terr)), size = 1) +  
  facet_wrap(~name, ncol = 3, nrow = 2) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.2), labels = percent, limits = c(0, 1)) +
  #scale_fill_viridis_d(begin = .15, end = .9, option = "inferno", direction = -1) +
  #scale_color_viridis_d(begin = .15, end = .9, option = "inferno", direction = -1) +
  scale_fill_manual(values = numic_palette, drop = FALSE) +
  scale_color_manual(values = numic_palette, drop = FALSE) +
  labs(
    title = "Neighborhood-level social cohesion according to perceptions of citizen security",
    subtitle = "Proportion of respondents scoring high on each cohesion indicator",
    caption = "Source: Own elaboration based on ELSOC 2016–2023. Weighted sample without attrition (N = 1648)",
    x = NULL, y = NULL,
    color = "Perceived security\nin the neighborhood",
    fill =  "Perceived security\nin the neighborhood"
  ) +
  theme_hc() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = 11, vjust = 1, hjust = 0.20, face = "bold"),
    plot.subtitle = element_text(size = 10, vjust = 1, hjust = 0.2),
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10),
    axis.text = element_text(size = 9),
    axis.text.x = element_text(angle = 65, vjust = 1, hjust = 1),  # etiquetas verticales
    strip.text = element_text(size = 10),
    plot.caption = element_text(size = 9, vjust = -1,  hjust = 0.2)
  )

ggsave(cob_inter_segu, filename = "../3_output/cohesion_barrial/cob_inter_segu.svg", width = 6, height = 4, units = "in", dpi = 2400)

# Mostrar gráfico
cob_inter_segu
```

```{r cob-territorial}
# -----------------------------
# Paleta continua institucional
# -----------------------------
pal_cont <- colorRampPalette(c("#E56A2F", "#9DB5A2", "#2E4553"))  # orange -> soft green -> petroleum blue

# 1) Weighted means by region (2023)
elsoc_region <- elsoc_base %>%
  filter(ola == "2023") %>%
  left_join(elsoc_chile %>% dplyr::select(idencuesta, region_cod), by = "idencuesta") %>%
  group_by(region_cod) %>%
  summarise(
    spbi_w = weighted.mean(spbi, ponderador02, na.rm = TRUE),
    soci_w = weighted.mean(soci, ponderador02, na.rm = TRUE),
    repu_w = weighted.mean(repu, ponderador02, na.rm = TRUE),
    segu_w = weighted.mean(segu, ponderador02, na.rm = TRUE),
    .groups = "drop"
  ) %>% 
  drop_na()

# 2) Regional geometry
geo_region <- generar_regiones() %>%
  mutate(codigo_region = str_remove(codigo_region, "^0"),
         codigo_region = as.numeric(codigo_region)) %>%
  rename(region_cod = codigo_region)

# 3) All regions x all variables
region_var_grid <- tidyr::expand_grid(
  region_cod = unique(geo_region$region_cod),
  variable = c("spbi_w", "soci_w", "repu_w", "segu_w")
)

# 4) Long format + full grid
elsoc_region_long <- elsoc_region %>%
  pivot_longer(cols = c(spbi_w, soci_w, repu_w, segu_w),
               names_to = "variable", values_to = "valor") %>%
  right_join(region_var_grid, by = c("region_cod", "variable"))

# 5) Join with geometry (sf)
elsoc_region_sf_long <- geo_region %>%
  left_join(elsoc_region_long, by = "region_cod")

# 6) Faceted map with continuous custom palette
cob_facet_plot <- ggplot(elsoc_region_sf_long) +
  geom_sf(aes(fill = valor, geometry = geometry), color = "black") +
  facet_wrap(
    ~ fct_rev(variable),
    ncol = 4,
    labeller = as_labeller(c(
      spbi_w = "Belonging",
      soci_w = "Sociability",
      repu_w = "Reputation",
      segu_w = "Security"
    ))
  ) +
  # Escala continua usando la paleta institucional
  scale_fill_gradientn(
    colours = pal_cont(200),
    name = "Level",
    limits = c(3.0, 4.5),     # ajusta si cambias el rango (Likert 1–5, etc.)
    na.value = "white",
    guide = guide_colorbar(barheight = unit(5, "cm"))
  ) +
  coord_sf(xlim = c(-77, -65)) +
  labs(
    title = "Neighborhoodlevel social cohesion and its correlates by region",
    subtitle = "Weighted regional mean for each indicator (scale '1 = Low' to '5 = High')",
    caption = "Source: Own elaboration based on ELSOC 2023. Weighted sample (N = 1837).",
    y = NULL, x = NULL
  ) +
  theme_hc() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = 13, vjust = 1, hjust = 0.25, face = "bold"),
    plot.subtitle = element_text(size = 11, vjust = 1, hjust = 0.2),
    legend.title = element_text(size = 10),
    legend.text = element_text(size = 12),
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks = element_blank(),
    strip.text = element_text(size = 10),
    plot.caption = element_text(size = 9, vjust = -1,  hjust = 0.2)
  )

# Mostrar
cob_facet_plot

# Guardar
ggsave(cob_facet_plot, filename = "../3_output/cohesion_barrial/cob_facet_plot.jpg", width = 6, height = 6, units = "in", dpi = 2400)

```

```{r}
# Cargar librerías
library(rsvg)
library(magick)

# Ruta al archivo SVG
svg_file <- "../3_output/cohesion_barrial/cob-region-draw.svg"  # Reemplaza con tu ruta

# Leer SVG con resolución High (2400 dpi ≈ 2400/72 * 1000 ≈ 33333)
# La función rsvg() no acepta directamente dpi, pero sí ancho/High en pixeles.
# Estimamos tamaño para ~2400 dpi (esto es aproximado y depende del tamaño original).
# Alternativa: usar rsvg_png() con tamaño forzado

# Convertimos SVG a PNG de High resolución temporalmente
temp_png <- tempfile(fileext = ".png")
rsvg_png(svg_file, file = temp_png, width = 10000, height = 10000)  # ajuste 

# Leer imagen PNG y convertir a JPG
img <- image_read(temp_png)

# Guardar como JPG con calidad máxima
image_write(img, path = "../3_output/cohesion_barrial/cob-region-plot.jpg", format = "jpeg", quality = 100)

# Opcional: eliminar el archivo temporal
unlink(temp_png)

```

```{r}
# 1. Cargar las librerías necesarias
# ggplot2 para la creación del gráfico y tibble para crear el data frame de forma ordenada.
library(ggplot2)
library(tibble)

# 2. Preparar los datos
# Creamos un data frame (una tabla) que contiene toda la información de nuestra paleta:
# el nombre del color, su código hexadecimal y las coordenadas (x, y) para ubicarlo en una grilla.

paleta_df <- tibble(
  nombre_es = c("Azul oscuro", "Azul grisáceo", "Gris azulado",
                "Naranja quemado", "Naranja", "Naranja claro",
                "Verde salvia", "Verde menta", "Verde pálido"),
  codigo_hex = c("#233640", "#2E4553", "#476473",
                 "#C75827", "#E56A2F", "#F08B57",
                 "#879F8D", "#9DB5A2", "#B7C8BE"),
  # Coordenadas para una grilla de 3x3.
  # 'rep' repite los valores para generar la grilla.
  x_coord = rep(1:3, times = 3),
  y_coord = rep(3:1, each = 3) # Usamos 3 a 1 para que el orden sea de arriba hacia abajo
)

# Creamos una columna para las etiquetas que irán dentro de cada cuadro.
# El símbolo "\n" crea un salto de línea entre el nombre y el código.
paleta_df$etiqueta <- paste(paleta_df$nombre_es, paleta_df$codigo_hex, sep = "\n")

# 3. Crear el gráfico con ggplot2
grafico_paleta <- ggplot(data = paleta_df, aes(x = x_coord, y = y_coord)) +
  # geom_tile() crea los cuadros de color.
  # Usamos aes(fill = codigo_hex) para que cada cuadro se rellene con su color.
  geom_tile(aes(fill = codigo_hex)) +
  
  # geom_text() añade el texto (las etiquetas) en el centro de cada cuadro.
  geom_text(aes(label = etiqueta), color = "white", size = 3.5, fontface = "bold") +
  
  # scale_fill_identity() le dice a ggplot que use los valores de la columna
  # 'codigo_hex' directamente como colores, sin intentar mapearlos a otra escala.
  scale_fill_identity() +
  
  # coord_fixed() asegura que los cuadros sean perfectamente cuadrados.
  coord_fixed() +
  
  # theme_void() elimina todos los elementos del gráfico que no necesitamos
  # (ejes, leyendas, fondo, etc.), dejando solo los cuadros de color.
  theme_void()

# 4. Mostrar el gráfico generado
print(grafico_paleta)


# (Opcional) Guardar el gráfico como una imagen PNG de alta calidad
ggsave("paleta_colores_hogarcito.png", plot = grafico_paleta, width = 6, height = 6, dpi = 300)
```

